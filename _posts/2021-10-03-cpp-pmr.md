---
layout: post
title: "C++ PMR"
date: 2021-10-03
tags: c++ memory c++17
---

## Predefined PMR collections
* <https://en.cppreference.com/w/cpp/memory/polymorphic_allocator> - pmr::vector, pmr::string, pmr::map ...

## Basic Example

```cpp
#include <algorithm>
#include <iostream>
#include <memory_resource>

int main () {
    // A small buffer on stack
    char buffer[20] = {0};
    std::fill_n(std::begin(buffer), std::size(buffer)-1, 'E');
    std::cout << buffer << '\n';

    std::pmr::monotonic_buffer_resource memory{std::data(buffer), std::size(buffer)};

    std::pmr::vector<char> vect{&memory};

    for (char c = 'a'; c <='e'; c++) {
        vect.emplace_back(c);
    }

    std::cout << buffer << '\n';
}
```

### Output
```
EEEEEEEEEEEEEEEEEEE
aababcdabcdeEEEEEEE
```

## Reserve Example

```cpp
#include <algorithm>
#include <iostream>
#include <memory_resource>

int main () {
    // A small buffer on stack
    char buffer[20] = {0};
    std::fill_n(std::begin(buffer), std::size(buffer)-1, 'E');
    std::cout << buffer << '\n';

    std::pmr::monotonic_buffer_resource memory{std::data(buffer), std::size(buffer)};

    std::pmr::vector<char> chars{&memory};
    chars.reserve(20);

    for (char c = 'a'; c <='e'; c++) {
        chars.emplace_back(c);
    }

    std::cout << buffer << '\n';
}
```

### Output
```
EEEEEEEEEEEEEEEEEEE
abcdeEEEEEEEEEEEEEE
```

## Using PMR collection of PMR collection Example

```cpp
#include <algorithm>
#include <iostream>
#include <memory_resource>

void Printer(char* buffer, std::string_view title) {
    std::cout << title << '\n';
    auto buff = std::string_view(buffer, 256);
    for (const auto& ch : buff) {
        if (ch >= ' ' ? ch : '_') {
            std::cout << ch;
        }
    }

    std::cout << " !endof buffer! \n";
}

int main () {
    // A small buffer on stack
    char buffer[256] = {};
    std::fill_n(std::begin(buffer), std::size(buffer)-1, '#');
    std::cout << buffer << '\n';

    Printer(buffer, "Empty buffer:");

    std::pmr::monotonic_buffer_resource pool{std::data(buffer), std::size(buffer)};

    std::pmr::vector<std::pmr::string> vec{&pool};
    vec.reserve(4);

    vec.emplace_back("Hello Darkness");
    vec.emplace_back("My Old Friend");

    Printer(buffer, "Tree string in:");

    vec.emplace_back("This is a longer string so what will happen now ?????  well it will not");

    Printer(buffer, "Long string:");
    
    vec.emplace_back("1234");

    Printer(buffer, "saved on buffer again");
}
```

### Output
```
###############################################################################################################################################################################################################################################################
Empty buffer:
############################################################################################################################################################################################################################################################### !endof buffer! 
Tree string in:
ï¿½ï¿½Q"ï¿½ï¿½ï¿½Q"ï¿½Hello Darkness#ï¿½ï¿½Q"ï¿½ï¿½Q"ï¿½
My Old Friend################################################################################################################################################################################# !endof buffer! 
Long string:
ï¿½ï¿½Q"ï¿½ï¿½ï¿½Q"ï¿½Hello Darkness#ï¿½ï¿½Q"ï¿½ï¿½Q"ï¿½
My Old Friend##ï¿½ï¿½Q"ï¿½pï¿½Q"ï¿½GG################################################This is a longer string so what will happen now ?????  well it will not####################### !endof buffer! 
saved on buffer again
ï¿½ï¿½Q"ï¿½ï¿½ï¿½Q"ï¿½Hello Darkness#ï¿½ï¿½Q"ï¿½ï¿½Q"ï¿½
My Old Friend##ï¿½ï¿½Q"ï¿½pï¿½Q"ï¿½GG########ï¿½ï¿½Q"ï¿½`ï¿½Q"ï¿½1234###########This is a longer string so what will happen now ?????  well it will not####################### !endof buffer! 
```

### Output with std::string - long string is lost
```
###############################################################################################################################################################################################################################################################
Empty buffer:
############################################################################################################################################################################################################################################################### !endof buffer! 
Tree string in:
ï¿½bAdï¿½Hello Darkness#ï¿½bAdï¿½
My Old Friend################################################################################################################################################################################################# !endof buffer! 
Long string:
ï¿½bAdï¿½Hello Darkness#ï¿½bAdï¿½
My Old Friend##ï¿½~@GG####################################################################################################################################################################### !endof buffer! 
saved on buffer again
ï¿½bAdï¿½Hello Darkness#ï¿½bAdï¿½
My Old Friend##ï¿½~@GG########ï¿½bAdï¿½1234########################################################################################################################################## !endof buffer! 
```

## References
* [Core C++ 2021 :: C++17 key features](https://www.youtube.com/watch?v=3gGhP0C-xOY)
* [PMR And Allocators](https://www.youtube.com/playlist?list=PLs3KjaCtOwSYX3X0L36NgwK0pxZZavDSF)
* <https://en.cppreference.com/w/cpp/header/memory_resource>
